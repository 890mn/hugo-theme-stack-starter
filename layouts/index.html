{{ define "main" }}
    {{ $slides := slice }}
    {{ with site.GetPage "post/HinarUI" }}
        {{ $slides = $slides | append . }}
    {{ end }}
    {{ with site.GetPage "post/Uranus23" }}
        {{ $slides = $slides | append . }}
    {{ end }}
    {{ with site.GetPage "post/algorithm" }}
        {{ $slides = $slides | append . }}
    {{ end }}

    <section class="home-hero home-hero--carousel">
        <div class="home-hero__carousel" data-interval="6000">
            <button class="home-hero__nav home-hero__nav--prev" type="button" aria-label="上一张">
                <span aria-hidden="true">←</span>
            </button>
            <button class="home-hero__nav home-hero__nav--next" type="button" aria-label="下一张">
                <span aria-hidden="true">→</span>
            </button>
            <div class="home-hero__track">
                {{ range $index, $page := $slides }}
                    {{ $image := "" }}
                    {{ with $page.Params.image }}
                        {{ with $page.Resources.GetMatch . }}
                            {{ $image = .RelPermalink }}
                        {{ end }}
                    {{ end }}
                    <article class="home-hero__slide{{ if eq $index 0 }} is-active{{ end }}" data-slide-index="{{ $index }}" data-slide-link="{{ $page.RelPermalink }}"{{ if $image }} style="--slide-bg: url('{{ $image }}')"{{ end }}>
                        <div class="home-hero__overlay">
                            <p class="home-hero__eyebrow">精选内容</p>
                            <h2 class="home-hero__headline">{{ $page.Title }}</h2>
                            {{ with $page.Params.description }}
                                <p class="home-hero__summary">{{ . }}</p>
                            {{ end }}
                            <span class="home-hero__cta">点击查看 →</span>
                        </div>
                    </article>
                {{ end }}
            </div>
            <div class="home-hero__dots" role="tablist" aria-label="精选文章轮播">
                {{ range $index, $_ := $slides }}
                    <button class="home-hero__dot{{ if eq $index 0 }} is-active{{ end }}" type="button" aria-label="切换到第 {{ add $index 1 }} 张" aria-pressed="{{ if eq $index 0 }}true{{ else }}false{{ end }}" data-slide-dot="{{ $index }}"></button>
                {{ end }}
            </div>
        </div>
        <a class="home-hero__scroll" href="#home-content" aria-label="向下滑动查看更多">
            <span aria-hidden="true">↓</span>
        </a>
    </section>

    <section id="home-content" class="article-list">
        {{ $pages := where .Site.RegularPages "Type" "in" .Site.Params.mainSections }}
        {{ $filtered := where $pages "Params.hidden" "!=" true }}
        {{ $pag := .Paginate ($filtered) }}
        {{ range $index, $element := $pag.Pages }}
            {{ partial "article-list/default" . }}
        {{ end }}
    </section>

    {{- partial "pagination.html" . -}}
    {{- partial "footer/footer" . -}}

    <script>
        (() => {
            const carousel = document.querySelector(".home-hero__carousel");
            if (!carousel) return;

            const slides = Array.from(carousel.querySelectorAll(".home-hero__slide"));
            const dots = Array.from(carousel.querySelectorAll(".home-hero__dot"));
            const prevButton = carousel.querySelector(".home-hero__nav--prev");
            const nextButton = carousel.querySelector(".home-hero__nav--next");
            const interval = Number(carousel.dataset.interval) || 6000;
            let activeIndex = 0;
            let timer = null;

            const setActive = (index) => {
                if (!slides.length) return;
                activeIndex = (index + slides.length) % slides.length;
                slides.forEach((slide, idx) => {
                    slide.classList.toggle("is-active", idx === activeIndex);
                });
                dots.forEach((dot, idx) => {
                    const isActive = idx === activeIndex;
                    dot.classList.toggle("is-active", isActive);
                    dot.setAttribute("aria-pressed", isActive ? "true" : "false");
                });
            };

            const goNext = () => setActive(activeIndex + 1);
            const goPrev = () => setActive(activeIndex - 1);

            const stopAuto = () => {
                if (timer) {
                    window.clearInterval(timer);
                    timer = null;
                }
            };

            const startAuto = () => {
                stopAuto();
                timer = window.setInterval(goNext, interval);
            };

            slides.forEach((slide) => {
                slide.addEventListener("click", (event) => {
                    if (event.target.closest("a, button")) return;
                    const link = slide.dataset.slideLink;
                    if (link) window.location.href = link;
                });
            });

            dots.forEach((dot) => {
                dot.addEventListener("click", () => {
                    const index = Number(dot.dataset.slideDot || 0);
                    setActive(index);
                    startAuto();
                });
            });

            prevButton?.addEventListener("click", (event) => {
                event.stopPropagation();
                goPrev();
                startAuto();
            });

            nextButton?.addEventListener("click", (event) => {
                event.stopPropagation();
                goNext();
                startAuto();
            });

            carousel.addEventListener("mouseenter", stopAuto);
            carousel.addEventListener("mouseleave", startAuto);

            startAuto();
        })();
    </script>
{{ end }}

{{ define "right-sidebar" }}
    {{ partial "sidebar/right.html" (dict "Context" . "Scope" "homepage") }}
{{ end }}
